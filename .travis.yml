language: go
sudo: false

#go_import_path: github.com/criteo-forks/azure_metrics_exporter

install: true
script:
- find . -type f \( -name "*go" -o -name ".promu.yml" \) | xargs sed 's|github.com/RobustPerception/azure_metrics_exporter|github.com/criteo-forks/azure_metrics_exporter|'
  -i
- export VERSION=$(echo $TRAVIS_TAG | sed 's/^v//')
- make format
- gofmt -s -w main.go
- make -j 3 multiarch
before_deploy:
  - echo "Deploying $VERSION to GitHub releases"
  - for d  in $(find ./pkg/bin -maxdepth 1 -mindepth 1 -type d | cut -d '/' -f4); do tar -czf azure_metrics_exporter-${VERSION}_${d}.tar.gz ./pkg/bin/${d}/azure_metrics_exporter* ; done

deploy:
  provider: releases
  api_key:
    secure: Dt5ZAdqyMPFtDZIXMibDYVfCaYR8qE2yrLy6ikDW6QNaMh146DmDE0NMelwwI/HA6Mx2E/rjRo1lgs/09dmmqq77uRvheUQU0AkOfBEYOWVhgwuWHFGPubTXz/Eisk37F523+bH7Br9xYazxoFY9JbaToTTmkppMyTJwlc6sZ+Xc2LvgmBtSu5hneMBWIlmksm2GMA/+5vuU24O55VuH2bYoLhOuiHf8fY5F9i1WVquM8sSHyJfVAXI1zDBpsXynO8saw1RcW1fD31Woe77sgDSFJF1gOmrbUNuMVfX56Mng76C58YyIRygkdiP9prxcp70a2YNf7qPDDJ4yRdAS7HsSWq2YIGAQvQxlCuuePlMZ8pHfkf1qnHMy7O2Ef5JC8yFAwGxKUt6cMAUJEOelx79ysR1rNToTJI3ROEfsf+MhLjdjyTUcODdChr2ZKN0aznCs36hnAI418FjiUd3xYVEVv3pjLcifmLELyufyefNLwyTWImZvvaVnWFo0dPWCl9W/ZIaz8ar+suOds5qU6REahqkabvijlzATsgRnAGVZ3tlw2iGdofFLuibGOkHSxfktMutdF4zF4QCoQ1IJUwBZoPcat2h+E11N2lhNjIMJjFkWajDRR264upseKqYmd0BwNjAF+f4M8lH/LLD6pEQ/7MvkejQ+CHwD25U7Rcc=
  file_glob: true
  file: azure_metrics_exporter-*.tar.gz
  skip_cleanup: true
  on:
    repo: criteo-forks/azure_metrics_exporter
    tags: true

